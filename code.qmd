---
title: "_Azospirillum brasilense_ as a bioinoculant to alleviate salinity effects on quinoa seed germination"
author: "Jose David Apaza-Calcina, Milagros Ninoska Munoz-Salas, Flavio Lozano-Isla, Rachel Passos Rezende, Raner Santana"
format:
  html:
    toc: true
    toc-expand: 2
    toc-location: left
    number-sections: true
    self-contained: true
    code-fold: true
    output-file: "ESM_01"
editor_options: 
  chunk_output_type: console
execute: 
  warning: false
  message: false
  echo: true
---

# Project Setup

```{r}
#| label:  setup

source('https://inkaverse.com/setup.r')
library(GerminaR)
library(scales)

cat("Project: ", getwd())
cat("CPU cores available: ", parallel::detectCores())
RhpcBLASctl::blas_set_num_threads(parallel::detectCores()*0.8)
session_info()
```

# Base de datos

> https://docs.google.com/spreadsheets/d/1t20oZQ_NR4zC8-gwkmV6UUMZwC24Hvh6WNJVtCXCF30/edit?gid=506947099#gid=506947099

# Import data

```{r}
gs <- "https://docs.google.com/spreadsheets/d/1t20oZQ_NR4zC8-gwkmV6UUMZwC24Hvh6WNJVtCXCF30/edit?gid=506947099#gid=506947099" %>% 
  as_sheets_id()

germ <- gs %>%
  range_read("radicula") %>%
  rename_with(~ iconv(.x, from = "UTF-8", to = "ASCII//TRANSLIT")) %>% 
  rename_with(~ str_replace_all(.x, "^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$", "")) %>% 
  rename_with(~ tolower(gsub("[^[:alnum:]_]", "_", .x))) %>% 
  mutate(across(1:nacl, ~ as.factor(.))) %>% 
  dplyr::select(where(~ mean(!is.na(.)) >= 0.1))
  
germ %>% str()

germ %>% web_table()

cot <- gs %>%
  range_read("germination") %>%
  rename_with(~ iconv(.x, from = "UTF-8", to = "ASCII//TRANSLIT")) %>% 
  rename_with(~ str_replace_all(.x, "^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$", "")) %>% 
  rename_with(~ tolower(gsub("[^[:alnum:]_]", "_", .x))) %>% 
  mutate(across(1:nacl, ~ as.factor(.))) %>% 
  dplyr::select(where(~ mean(!is.na(.)) >= 0.1))
  
cot %>% str()

cot %>% web_table()

growth <- gs %>%
  range_read("growth") %>%
  rename_with(~ iconv(.x, from = "UTF-8", to = "ASCII//TRANSLIT")) %>% 
  rename_with(~ str_replace_all(.x, "^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$", "")) %>% 
  rename_with(~ tolower(gsub("[^[:alnum:]_]", "_", .x))) %>% 
  mutate(across(1:repetition, ~ as.factor(.))) %>% 
  dplyr::select(where(~ mean(!is.na(.)) >= 0.1))
  
growth %>% str()

growth %>% web_table()

bacterial <- gs %>%
  range_read("bacterial") %>%
  rename_with(~ iconv(.x, from = "UTF-8", to = "ASCII//TRANSLIT")) %>% 
  rename_with(~ str_replace_all(.x, "^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$", "")) %>% 
  rename_with(~ tolower(gsub("[^[:alnum:]_]", "_", .x))) %>% 
  mutate(across(1:repetition, ~ as.factor(.))) %>% 
  dplyr::select(where(~ mean(!is.na(.)) >= 0.1))
  
bacterial %>% str()

bacterial %>% web_table()

# https://colorbrewer2.org/
```

# Statistical Analysis

## To determine the growth capacity of BR-11001 and BR-11002 in saline media, as a proxy for their viability and functional persistence under stress.


```{r}
dtx <- bacterial 
# trait <- "bacterial_growth"

dtx %>% str()

rs <- xfun::cache_rds({
  
  traits <- names(dtx)[4:length(dtx)]
  
  results <- traits %>% set_names() %>% map( \(trait) {
    
    # Liberar memoria
    gc()
    
    # Definir modelo
    mdf <- paste(trait, "0 + strains*nacl + (1|repetition)", sep = " ~ ") 
    
    # Mostrar qué rasgo se analiza
    cat("\n\n## Análisis para: ", trait, "\n\n")
    
    
    cat("\n\n### Diagnostico de modelo\n\n")
    
    # Remover outliers (asumo que tienes esta función personalizada)
    md <- dtx %>% 
      remove_outliers(as.formula(mdf),
                      plot_diag = TRUE,
                      drop_na = TRUE)
    
    md$diagplot %>% print()
    
    if (nrow(md$outliers) > 0) {
    cat("> Outliers detectados\n")
    md$outliers %>% kable() %>% print()
    } else {
    cat("> No se detectaron outliers\n")
    }
    
    mdc <- md$model$clean
    
    cat("\n\n### ANOVA tipo III\n\n")
    
    Anova(mdc, type = 3, test.statistic = "F") %>%  print()
    
    cat("\n\n### Comparaciones múltiples (Emmeans)\n\n")
    
    # Comparaciones múltiples into the groups
    mc_in <- emmeans(mdc, ~ strains|nacl, type = "response") %>% 
      cld(Letters = letters, reversed = TRUE) %>% 
      mutate(across(".group", trimws)) %>% 
      mutate(across(".group", tolower)) %>% 
      rename(sig_in = ".group")
    
    mc_ou <- emmeans(mdc, ~ nacl|strains, type = "response") %>% 
      cld(Letters = letters, reversed = TRUE) %>% 
      mutate(across(".group", trimws)) %>% 
      mutate(across(".group", toupper)) %>% 
      rename(sig_ou = ".group")
    
    mc <- merge(mc_in, mc_ou) %>% 
      unite(col = "sig", c("sig_in", "sig_ou"), sep = "")
    
    mc %>% kable() %>% print()
    
    cat("\n\n### Gráfico resumen\n\n")
    
    plot <- mc %>% 
      plot_smr(type = "line",
               x = "nacl",
               y = "emmean"
               , group = "strains"
               , ylab = trait
               , sig = "sig"
               , error = "SE") +
      scale_color_manual(values = c("#fbb4ae", "#b3cde3", "#ccebc5"
                                    , "#decbe4", "#fed9a6", "#ffffcc"))
    
    plot %>% print()
    
    list(mc = mc,
         plot = plot
         )
  })
  
  results
  
}, file = "result.rds", rerun = T)
```

```{r}
plots <- list(rs$od_600_nm$plot +
                scale_y_continuous(limits = c(0, 1.75)
                                  , breaks = seq(0, 200, by = 0.25)) +
                labs(x = ""
                     , y = expression(OD[600]~"(nm)")
                     ) +
                theme(legend.position = "none"
                      , axis.text.x = element_blank()
                      , strip.text = element_blank()
                      )
              , rs$bacterial_growth$plot +
                scale_y_log10(
                  limits = c(2e8, 20e8),
                  breaks = 10^seq(8, 20, by = 0.1),
                  labels = trans_format("log10", math_format(10^.x))
                  ) +
                labs(x = ""
                     , y = "Bacterial growth"
                     ) +
                theme(legend.position = "none"
                      # , axis.text.x = element_blank()
                      # , strip.text = element_blank()
                      )
              )

legend <- get_plot_component(
  rs$bacterial_growth$plot +
    guides(color = guide_legend(nrow = 1)) +  # Esto fuerza una sola línea
    theme(
      legend.position = "bottom",
      legend.direction = "horizontal",
      legend.box = "horizontal"
    ),
  "guide-box",
  return_all = TRUE
)

fgrids <- plots %>% 
  cowplot::plot_grid(plotlist = ., ncol = 1, labels = "auto") 

export <-  list(legend[[3]], fgrids) %>% 
  cowplot::plot_grid(plotlist = .
                     , ncol = 1
                     , rel_heights = c(0.1, 1))
  
plot <- export %>% 
  ggsave(plot = ., "manuscript/Figure-01.jpg", width = 22, height = 20
         , units = "cm")

plot %>% include_graphics()
```

## To assess the effect of salinity gradient (0 to 450 mM NaCl) on seed germination and cotyledon emergence as indicators of bacterial efficacy

```{r}
# germination analysis (ten variables)

gsm <- germ %>% 
  as.data.frame() %>% 
  ger_summary(SeedN = "seeds"
              , evalName = "d"
              , data = .
              ) %>% 
  dplyr::select(1:nacl, grp, mgt, unc, syn)

gsm %>% kable()
```

```{r}
dt <- gsm %>% 
  mutate(strains = factor(strains
                         , levels = c("Control", "BR-11001", "BR-11002")
                         , ordered = TRUE))

rs <- xfun::cache_rds({
  
  traits <- names(dt)[4:length(dt)]
  # trait <- "grp" 
  
  results <- traits %>% set_names() %>% map( \(trait) {
    
    # Liberar memoria
    gc()
    
    # Definir modelo
    mdf <- paste(trait, "0 + strains*nacl + (1|repetition)", sep = " ~ ") 
    
    # Mostrar qué rasgo se analiza
    cat("\n\n## Análisis para: ", trait, "\n\n")
    
    
    cat("\n\n### Diagnostico de modelo\n\n")
    
    # Remover outliers (asumo que tienes esta función personalizada)
    md <- dt %>% 
      remove_outliers(as.formula(mdf),
                      plot_diag = TRUE,
                      drop_na = TRUE)
    
    md$diagplot %>% print()
    
    if (nrow(md$outliers) > 0) {
    cat("> Outliers detectados\n")
    md$outliers %>% kable() %>% print()
    } else {
    cat("> No se detectaron outliers\n")
    }
    
    mdc <- md$model$raw
    
    cat("\n\n### ANOVA tipo III\n\n")
    
    Anova(mdc, type = 3, test.statistic = "F") %>%  print()
    
    cat("\n\n### Comparaciones múltiples (Emmeans)\n\n")
    
    # Comparaciones múltiples into the groups
    mc_in <- emmeans(mdc, ~ strains|nacl, type = "response") %>% 
      cld(Letters = letters, reversed = TRUE) %>% 
      mutate(across(".group", trimws)) %>% 
      mutate(across(".group", tolower)) %>% 
      rename(sig_in = ".group")
    
    mc_ou <- emmeans(mdc, ~ nacl|strains, type = "response") %>% 
      cld(Letters = letters, reversed = TRUE) %>% 
      mutate(across(".group", trimws)) %>% 
      mutate(across(".group", toupper)) %>% 
      rename(sig_ou = ".group")
    
    mc <- merge(mc_in, mc_ou) %>% 
      unite(col = "sig", c("sig_in", "sig_ou"), sep = "")
    
    mc %>% kable() %>% print()
    
    cat("\n\n### Gráfico resumen\n\n")
    
    plot <- mc %>% 
      plot_smr(type = "line",
               x = "nacl",
               y = "emmean"
               , group = "strains"
               , ylab = trait
               , sig = "sig"
               , error = "SE") +
      scale_color_manual(values = c("#fbb4ae", "#b3cde3", "#ccebc5"))
    
    plot %>% print()
    
    list(mc = mc,
         plot = plot
         )
  })
  
  results
  
}, file = "result.rds", rerun = T)
```

```{r}
plots <- list(rs$grp$plot +
                scale_y_continuous(limits = c(50, 110)
                                  , breaks = seq(0, 200, by = 10)) +
                labs(x = ""
                     , y = "Germination percentage (%)"
                     ) +
                theme(legend.position = "none"
                      , axis.text.x = element_blank()
                      , strip.text = element_blank()
                      )
              , rs$mgt$plot +
                scale_y_continuous(limits = c(1, 6)
                                  , breaks = seq(0, 200, by = 1)) +
                labs(x = ""
                     , y = "Mean germination time (days)"
                     ) +
                theme(legend.position = "none"
                      , axis.text.x = element_blank()
                      , strip.text = element_blank()
                      )
              , rs$unc$plot +
                scale_y_continuous(limits = c(0.25, 3.25)
                                  , breaks = seq(0, 100, by = 0.5)) +
                labs(x = "NaCl (mM)"
                     , y = "Germination uncertainty"
                     ) +
                theme(legend.position = "none"
                      )
              , rs$syn$plot +
                scale_y_continuous(limits = c(0, 1)
                                  , breaks = seq(0, 100, by = 0.25)) +
                labs(x = "NaCl (mM)"
                     , y = "Germination synchrony"
                     ) +
                theme(legend.position = "none"
                      , axis.text.y = element_text(angle = 90)
                      )
              )

# extraer leyenda
legend <- get_plot_component(rs$grp$plot +
                               theme(legend.position = "top"
                                     , legend.direction = "horizontal")
                             , "guide-box", return_all = T)

fgrids <- plots %>% 
  cowplot::plot_grid(plotlist = ., ncol = 2, labels = "auto") 

export <-  list(legend[[4]], fgrids) %>% 
  cowplot::plot_grid(plotlist = .
                     , ncol = 1
                     , rel_heights = c(0.1, 1))
  
plot <- export %>% 
  ggsave(plot = ., "manuscript/Figure-02.jpg", width = 20, height = 18
         , units = "cm")

plot %>% include_graphics()
```

## To quantify seedling growth by measuring shoot and root length and dry biomass in inoculated versus non-inoculated treatments under saline and non-saline conditions

```{r}
dtx <- growth %>% 
  mutate(strains = factor(strains
                         , levels = c("Control", "BR-11001", "BR-11002")
                         , ordered = TRUE))
# trait <- "shoot_length" 

rs <- xfun::cache_rds({
  
  traits <- names(dtx)[4:length(dtx)]
  
  results <- traits %>% set_names() %>% map( \(trait) {
    
    # Liberar memoria
    gc()
    
    # Definir modelo
    mdf <- paste(trait, "0 + strains*nacl + (1|repetition)", sep = " ~ ") 
    
    # Mostrar qué rasgo se analiza
    cat("\n\n## Análisis para: ", trait, "\n\n")
    
    
    cat("\n\n### Diagnostico de modelo\n\n")
    
    # Remover outliers (asumo que tienes esta función personalizada)
    md <- dtx %>% 
      remove_outliers(as.formula(mdf),
                      plot_diag = TRUE,
                      drop_na = TRUE)
    
    md$diagplot %>% print()
    
    if (nrow(md$outliers) > 0) {
    cat("> Outliers detectados\n")
    md$outliers %>% kable() %>% print()
    } else {
    cat("> No se detectaron outliers\n")
    }
    
    mdc <- md$model$clean
    
    cat("\n\n### ANOVA tipo III\n\n")
    
    Anova(mdc, type = 3, test.statistic = "F") %>%  print()
    
    cat("\n\n### Comparaciones múltiples (Emmeans)\n\n")
    
    # Comparaciones múltiples into the groups
    mc_in <- emmeans(mdc, ~ strains|nacl, type = "response") %>% 
      cld(Letters = letters, reversed = TRUE) %>% 
      mutate(across(".group", trimws)) %>% 
      mutate(across(".group", tolower)) %>% 
      rename(sig_in = ".group")
    
    mc_ou <- emmeans(mdc, ~ nacl|strains, type = "response") %>% 
      cld(Letters = letters, reversed = TRUE) %>% 
      mutate(across(".group", trimws)) %>% 
      mutate(across(".group", toupper)) %>% 
      rename(sig_ou = ".group")
    
    mc <- merge(mc_in, mc_ou) %>% 
      unite(col = "sig", c("sig_in", "sig_ou"), sep = "")
    
    mc %>% kable() %>% print()
    
    cat("\n\n### Gráfico resumen\n\n")
    
    plot <- mc %>% 
      plot_smr(type = "line",
               x = "nacl",
               y = "emmean"
               , group = "strains"
               , ylab = trait
               , sig = "sig"
               , error = "SE") +
      scale_color_manual(values = c("#fbb4ae", "#b3cde3", "#ccebc5"))
    
    plot %>% print()
    
    list(mc = mc,
         plot = plot
         )
  })
  
  results
  
}, file = "result.rds", rerun = T)
```

```{r}
plots <- list(rs$shoot_length$plot +
                scale_y_continuous(limits = c(1, 7)
                                  , breaks = seq(0, 200, by = 1)) +
                labs(x = ""
                     , y = "Shoot length (cm)"
                     ) +
                theme(legend.position = "none"
                      , axis.text.x = element_blank()
                      , strip.text = element_blank()
                      )
              , rs$root_length$plot +
                scale_y_continuous(limits = c(0.5, 4.5)
                                  , breaks = seq(0, 200, by = 0.5)) +
                labs(x = ""
                     , y = "Root length (cm)"
                     ) +
                theme(legend.position = "none"
                      , axis.text.x = element_blank()
                      , strip.text = element_blank()
                      )
              , rs$dry_weight$plot +
                scale_y_continuous(limits = c(0.01, 0.06)
                                  , breaks = seq(0, 100, by = 0.01)) +
                labs(x = "NaCl (mM)"
                     , y = "Dry weight (g)"
                     ) +
                theme(legend.position = "none"
                      , axis.text.y = element_text(angle = 90)
                      )
              , rs$humidity_cont$plot +
                scale_y_continuous(limits = c(0.1, 0.6)
                                  , breaks = seq(0, 100, by = 0.1)) +
                labs(x = "NaCl (mM)"
                     , y = "Moisture content (%)"
                     ) +
                theme(legend.position = "none"
                      , axis.text.y = element_text(angle = 90)
                      )
              )

# extraer leyenda
legend <- get_plot_component(rs$shoot_length$plot +
                               theme(legend.position = "top"
                                     , legend.direction = "horizontal")
                             , "guide-box", return_all = T)

fgrids <- plots %>% 
  cowplot::plot_grid(plotlist = ., ncol = 2, labels = "auto") 

export <-  list(legend[[4]], fgrids) %>% 
  cowplot::plot_grid(plotlist = .
                     , ncol = 1
                     , rel_heights = c(0.1, 1))
  
plot <- export %>% 
  ggsave(plot = ., "manuscript/Figure-03.jpg", width = 22, height = 20
         , units = "cm")

plot %>% include_graphics()
```

## To evaluate physiological responses to salinity through the activity of antioxidant enzymes (SOD, CAT, APX, GPX)

```{r}
plots <- list(rs$sod$plot +
                scale_y_continuous(limits = c(20, 70)
                                  , breaks = seq(0, 200, by = 10)) +
                labs(x = ""
                     , y = "Superoxide dismutase (SOD)"
                     ) +
                theme(legend.position = "none"
                      , axis.text.x = element_blank()
                      , strip.text = element_blank()
                      )
              , rs$cat$plot +
                scale_y_continuous(limits = c(10, 50)
                                  , breaks = seq(0, 200, by = 10)) +
                labs(x = ""
                     , y = "Catalase (CAT)"
                     ) +
                theme(legend.position = "none"
                      , axis.text.x = element_blank()
                      , strip.text = element_blank()
                      )
              , rs$apx$plot +
                scale_y_continuous(limits = c(7.5, 35)
                                  , breaks = seq(0, 100, by = 5)) +
                labs(x = "NaCl (mM)"
                     , y = "Ascorbate peroxidase (APX)"
                     ) +
                theme(legend.position = "none"
                      )
              , rs$gpx$plot +
                scale_y_continuous(limits = c(5, 25)
                                  , breaks = seq(0, 100, by = 5)) +
                labs(x = "NaCl (mM)"
                     , y = "Guaiacol peroxidase (GPX)"
                     ) +
                theme(legend.position = "none"
                      )
              )

# extraer leyenda
legend <- get_plot_component(rs$shoot_length$plot +
                               theme(legend.position = "top"
                                     , legend.direction = "horizontal")
                             , "guide-box", return_all = T)

fgrids <- plots %>% 
  cowplot::plot_grid(plotlist = ., ncol = 2, labels = "auto") 

export <-  list(legend[[4]], fgrids) %>% 
  cowplot::plot_grid(plotlist = .
                     , ncol = 1
                     , rel_heights = c(0.1, 1))
  
plot <- export %>% 
  ggsave(plot = ., "manuscript/Figure-04.jpg", width = 22, height = 20
         , units = "cm")

plot %>% include_graphics()
```


